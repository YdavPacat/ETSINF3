#+TITLE: Pract1
* Base de Datos CINE

#+NAME: Base de datos CINE
[[./CINE.png]]

** Consultas sobre una sola tabla
*** 1. Obtener ordenados ascendentemente los códigos de los países de donde son los actores

#+begin_src sql
SELECT DISTINCT cod_pais
FROM actor
ORDER BY cod_pais;
#+end_src

*** 2. Obtener el código y el título de las películas de año anterior a 1970 que no estén basadas en ningún libro ordenadas por título.

#+begin_src sql
SELECT cod_peli, titulo
FROM pelicula
WHERE anyo < 1970 AND cod_lib IS NULL
ORDER BY titulo;
#+end_src

*** 3. Obtener el código y el nombre de los actores cuyo nombre incluye “John”.

#+begin_src sql
SELECT cod_act, nombre
FROM actor
WHERE nombre LIKE '%John%'
#+end_src

*** 4. Obtener el código y el título de las películas de más de 120 minutos de la década de los 80

#+begin_src sql
SELECT cod_peli, titulo
FROM pelicula
WHERE duracion > 120 AND anyo BETWEEN 1980 AND 1989
ORDER BY titulo;
#+end_src

*** 5. Obtener el código y el título de las películas que estén basadas en algún libro y cuyo director se apellide ‘Pakula’.

#+begin_src sql
SELECT cod_peli, titulo
FROM pelicula
WHERE cod_lib is not null and director LIKE '% Pakula%'
#+end_src

*** 6. ¿Cuántas películas hay de más de 120 minutos de la década de los 80?

#+begin_src sql
SELECT count(*)
FROM pelicula
WHERE duracion > 120 AND anyo BETWEEN 1980 AND 1989
ORDER BY titulo;
#+end_src

*** 7. ¿Cuántas películas se han clasificado de los géneros de código 'BB5' o 'GG4' o'JH6'?

#+begin_src sql
SELECT count(DISTINCT cod_peli)
FROM clasificacion
WHERE cod_gen IN('BB5','GG4','JH6')
#+end_src

*** 8. ¿De qué año es el libro más antiguo?

#+begin_src sql
SELECT MIN(anyo)
FROM libro_peli
#+end_src

*** 9. ¿Cuál es la duración media de las películas del año 1987?

#+begin_src sql
SELECT AVG(duracion)
FROM pelicula
WHERE anyo=1987
#+end_src

*** 10. ¿Cuántos minutos ocupan todas las películas dirigidas por ‘Steven Spielberg’?

#+begin_src sql
SELECT SUM(duracion)
FROM pelicula
WHERE director='Steven Spielberg'
#+end_src

** Consultas sobre varias tablas
*** 11. Obtener el código y el título de las películas en las que actúa un actor con el mismo nombre que el director de la película (ordenadas por título).

#+begin_src sql
SELECT p.cod_peli, p.titulo
FROM pelicula p, actua act, actor atr
WHERE act.cod_act=atr.cod_act and act.cod_peli=p.cod_peli and p.director=atr.nombre
ORDER BY p.titulo
#+end_src

*** 12. Obtener el código y el título de las películas clasificadas del género de nombre ‘Comedia’ (ordenadas por título).

#+begin_src sql
SELECT p.cod_peli, p.titulo
FROM pelicula p, clasificacion c, genero g
WHERE g.nombre='Comedia' and g.cod_gen=c.cod_gen and c.cod_peli=p.cod_peli
ORDER BY p.titulo
#+end_src

*** 13. Obtener el código y el título de las películas basadas en algún libro anterior a 1950

#+begin_src sql
SELECT cod_peli, pelicula.titulo
FROM pelicula, libro_peli l --Producto cartesiano de pelicula X libro
WHERE pelicula.cod_lib = l.cod_lib AND libro.anyo < 1950
#+end_src

*** 14. Obtener el código y el nombre de los países de los actores que actúan en películas clasificadas del género de nombre ‘Comedia’ (ordenados por nombre).

#+begin_src sql
SELECT DISTINCT pa.cod_pais, pa.nombre
FROM pais pa, actor atr, actua act, pelicula pe, clasificacion c, genero g
WHERE g.nombre='Comedia' and g.cod_gen=c.cod_gen and c.cod_peli=act.cod_peli and act.cod_act=atr.cod_act and atr.cod_pais=pa.cod_pais
ORDER BY pa.nombre
#+end_src

** Consultas con subconsultas
*** 15.11. Obtener el código y el título de las películas en las que actúa un actor con el mismo nombre que el director de la película (ordenadas por título).

#+begin_src sql
SELECT cod_peli, titulo
FROM Pelicula p
WHERE EXISTS (SELECT * 
              FROM Actua act 
              WHERE p.cod_peli = act.cod_peli AND
              act.cod_act IN (SELECT atr.cod_act 
                              FROM Actor atr 
                              WHERE p.director = atr.nombre))
ORDER BY titulo
#+end_src

*** 15.12. Obtener el código y el título de las películas clasificadas del género de nombre ‘Comedia’ (ordenadas portítulo).

#+begin_src sql
SELECT cod_peli, titulo
FROM Pelicula
WHERE cod_peli IN (SELECT c.cod_peli 
                   FROM Clasificacion c, Genero g 
                   WHERE g.nombre = 'Comedia' AND c.cod_gen = g.cod_gen)
ORDER BY titulo
#+end_src

*** 15.13. Obtener el código y el título de las películas basadas en algún libro anterior a 1950.

#+begin_src sql
SELECT cod_peli, titulo
FROM Pelicula
WHERE cod_lib IN (SELECT cod_lib FROM libro_peli WHERE anyo < 1950)
ORDER BY titulo
#+end_src

/Con EXISTS/
#+begin_src sql
SELECT p.con_peli, p.titulo
FROM pelicula p
WHERE EXISTS(
    SELECT
    FROM libro_peli l 
    WHERE l.cod_lib = p.cod_lib AND l.anyo < 1950
)
ORDER BY titulo
#+end_src

*** 15.14. Obtener el código y el nombre de los países de los actores que actúan en películas clasificadas del género de nombre ‘Comedia’ (ordenados por nombre).

#+begin_src sql
SELECT pa.cod_pais, pa.nombre
FROM Pais pa
WHERE pa.cod_pais IN 
    (SELECT pa.cod_pais 
    FROM Pais pa, Actor atr 
    WHERE pa.cod_pais = atr.cod_pais AND atr.cod_act IN 
        (SELECT act.cod_act 
        FROM Actua act, Clasificacion c 
        WHERE act.cod_peli = c.cod_peli AND c.cod_gen IN 
            (SELECT g.cod_gen 
            FROM Genero g 
            WHERE g.nombre = 'Comedia')))
ORDER BY pa.nombre
#+end_src

*** 16. Obtener el código y el nombre de los actores nacidos antes de 1950 que actúan con un papel ‘Principal’ en alguna película (ordenados por nombre).

#+begin_src sql
SELECT cod_act, nombre
FROM Actor
WHERE EXTRACT(YEAR FROM fecha_nac) < 1950 AND cod_act IN (SELECT cod_act FROM Actua WHERE papel = 'Principal')
ORDER BY nombre
#+end_src

*** 17. Obtener el código, el título y el autor de los libros en los que se ha basado alguna película de la década de los 90 (ordenados por título).

#+begin_src sql
SELECT cod_lib, titulo, autor
FROM Libro_peli
WHERE cod_lib IN (SELECT cod_lib FROM Pelicula WHERE anyo BETWEEN 1990 AND 1999 AND cod_lib IS NOT NULL)
ORDER BY titulo
#+end_src

*** 18. Obtener el código, el título y el autor de los libros en los que no se haya basado ninguna película

#+begin_src sql
SELECT cod_lib, titulo, autor
FROM Libro_peli
WHERE cod_lib NOT IN (SELECT cod_lib FROM Pelicula WHERE cod_lib IS NOT NULL)
#+end_src

*** 19. Obtener el nombre del género o géneros a los que pertenecen películas en las que no actúa ningún actor (ordenados por nombre).

#+begin_src sql
SELECT nombre
FROM Genero
WHERE cod_gen IN (SELECT cod_gen FROM Clasificacion WHERE cod_peli NOT IN (SELECT cod_peli FROM Actua))
ORDER BY nombre
#+end_src

*** 20. Obtener el título de los libros en los que se haya basado alguna película en la que no hayan actuado actores del país de nombre ‘USA’ (ordenados por título).

#+begin_src sql
SELECT l.titulo
FROM Libro_peli l
WHERE l.cod_lib IN (SELECT p.cod_lib 
                    FROM Pelicula p 
                    WHERE p.cod_peli NOT IN (SELECT act.cod_peli 
                                        FROM Actua act 
                                        WHERE act.cod_act IN (SELECT atr.cod_act 
                                                            FROM Actor atr 
                                                            WHERE atr.cod_pais IN (SELECT pa.cod_pais 
                                                                                  FROM Pais pa 
                                                                                  WHERE pa.nombre = 'USA'))))
ORDER BY l.titulo
#+end_src

*** 21. ¿Cuántas películas hay clasificadas del género de nombre ‘Comedia’ y en las que sólo aparece un actor con el papel ‘Secundario’?

#+begin_src sql
SELECT count(*)
FROM Pelicula p
WHERE p.cod_peli IN (SELECT c.cod_peli 
                    FROM Clasificacion c
                    WHERE c.cod_gen IN (SELECT g.cod_gen 
                                        FROM Genero g 
                                        WHERE g.nombre = 'Comedia')) AND p.cod_peli IN (SELECT a.cod_peli
                                                                                        FROM Actua a 
                                                                                        WHERE a.papel = 'Secundario')
#+end_src

*** 22. Obtener el año de la primera película en la que el actor de nombre ‘Jude Law’ tuvo un papel como ‘Principal’.

#+begin_src sql
SELECT MIN(p.anyo)
FROM Pelicula p
WHERE p.cod_peli IN (SELECT act.cod_peli 
                    FROM Actua act 
                    WHERE act.papel = 'Principal' AND act.cod_act IN (SELECT atr.cod_act 
                                                                    FROM Actor atr 
                                                                    WHERE atr.nombre = 'Jude Law'))
#+end_src

*** 23. Obtener el código y el nombre de actor o actores más viejos.

#+begin_src sql
SELECT cod_act, nombre
FROM Actor
WHERE fecha_nac = (SELECT MIN(fecha_nac) FROM Actor)
#+end_src

*** 24. Obtener el código, el nombre y la fecha de nacimiento del actor más viejo nacido en el año 1940

#+begin_src sql
SELECT cod_act, nombre, fecha_nac
FROM actor
WHERE fecha_nac = (SELECT MIN (fecha_nac) FROM actor WHERE fecha_nac LIKE '%1940')
#+end_src

*** 25. Obtener el nombre del género (o de los géneros) en los que se ha clasificado la película más larga

#+begin_src sql
SELECT nombre 
FROM genero
WHERE cod_gen IN (SELECT cod_gen 
                 FROM clasificacion
                 WHERE cod_peli = (SELECT cod_peli
                                   FROM pelicula
                                   WHERE duracion = (SELECT MAX(duracion) FROM pelicula)))
#+end_src

*** 26. Obtener el código y el título de los libros en los que se han basado películas en las que actúan actores del país de nombre España (ordenados por título

#+begin_src sql
SELECT cod_lib, titulo
FROM libro_peli
WHERE cod_lib IN (SELECT cod_lib
                  FROM pelicula
                  WHERE cod_peli IN (SELECT cod_peli
                                     FROM actua
                                     WHERE cod_act IN (SELECT cod_act 
                                                       FROM actor
                                                       WHERE cod_pais = (SELECT cod_pais 
                                                                         FROM pais
                                                                         WHERE nombre = 'España'))))
ORDER BY titulo
#+end_src

*** 27. Obtener el título de las películas anteriores a 1950 clasificadas en más de un género (ordenadas por título).

#+begin_src sql
SELECT p.titulo
FROM Pelicula p
WHERE anyo < 1950 AND p.cod_peli IN (SELECT c1.cod_peli 
                                    FROM Clasificacion c1, Clasificacion c2 
                                    WHERE c1.cod_gen <> c2.cod_gen AND c1.cod_peli = c2.cod_peli)
#+end_src

*** 28. Obtener la cantidad de películas en las que han participado menos de 4 actores

#+begin_src sql
SELECT count(*)
FROM Pelicula p
WHERE 4 > (SELECT count(*) FROM Actua a WHERE a.cod_peli = p.cod_peli)
#+end_src

*** 29. Obtener los directores que han dirigido más de 250 minutos entre todas sus películas.

#+begin_src sql
SELECT DISTINCT p1.director
FROM Pelicula p1
WHERE (250 - p1.duracion)  < (SELECT SUM(p2.duracion) 
                            FROM Pelicula p2 
                            WHERE  p1.director = p2.director AND p1.cod_peli <> p2.cod_peli) OR p1.duracion > 250
#+end_src

*** 30. Obtener el año o años en el que nacieron más de 3 actores.

#+begin_src sql
SELECT DISTINCT EXTRACT(YEAR FROM atr1.fecha_nac)
FROM Actor atr1
WHERE 2 < (SELECT COUNT (atr2.fecha_nac) 
            FROM Actor atr2 
            WHERE EXTRACT(YEAR FROM atr1.fecha_nac) = EXTRACT(YEAR FROM atr2.fecha_nac) and atr1.nombre <> atr2.nombre)
#+end_src

*** 31. Obtener el código y nombre del actor más joven que ha participado en una película clasificada del género de código ‘DD8’.

#+begin_src sql
SELECT atr.cod_act, atr.nombre
FROM Actor atr
WHERE atr.fecha_nac = (SELECT MIN(atr2.fecha_nac) 
                        FROM Actor atr2 
                        WHERE atr2.cod_act IN (SELECT act.cod_act 
                                                FROM Actua act 
                                                WHERE cod_peli IN (SELECT c.cod_peli 
                                                                    FROM Clasificacion c 
                                                                    WHERE cod_gen = 'DD8')))
#+end_src

** Consultas universalmente cuantificadas
*** 32. Obtener el código y el nombre de los países con actores y tales que todos los actores de ese país han nacido en el siglo XX (ordenados por nombre).

#+begin_src sql
SELECT p.cod_pais, p.nombre
FROM Pais p
WHERE p.cod_pais IN (SELECT a.cod_pais FROM Actor a) AND NOT EXISTS (SELECT a1.cod_pais FROM Actor a1 WHERE NOT (EXTRACT (YEAR FROM a1.fecha_nac)) BETWEEN 1900 AND 1999 AND p.cod_pais = a1.cod_pais) 
#+end_src

*** 33. Obtener el código y el nombre de los actores tales que todos los papeles que han tenido son de ‘Secundario’. Sólo interesan aquellos actores que hayan actuado en alguna película.

#+begin_src sql
SELECT atr.cod_act, atr.nombre
FROM Actor atr
WHERE atr.cod_act IN (SELECT act.cod_act FROM Actua act) AND NOT EXISTS (SELECT act1.cod_peli FROM Actua act1 WHERE act1.papel <> 'Secundario' AND atr.cod_act = act1.cod_act)
#+end_src

*** 34. Obtener el código y el nombre de los actores que han aparecido en todas las películas del director ‘Guy Ritchie’ (sólo si ha dirigido al menos una).

#+begin_src sql
SELECT atr.cod_act, atr.nombre
FROM Actor atr
WHERE 0 < (SELECT COUNT(*) FROM Pelicula p WHERE p.director = 'Guy Ritchie') AND EXISTS (SELECT act.cod_act FROM Actua act WHERE atr.cod_act = act.cod_act AND NOT EXISTS(SELECT p.cod_peli FROM Pelicula p WHERE p.director <> 'Guy Ritchie' AND act.cod_peli = p.cod_peli))
#+end_src

*** 35. Resolver la consulta anterior pero para el director de nombre ‘John Steel’.

#+begin_src sql
SELECT atr.cod_act, atr.nombre
FROM Actor atr
WHERE 0 < (SELECT COUNT(*) FROM Pelicula p WHERE p.director = 'Guy Ritchie') AND EXISTS (SELECT act.cod_act FROM Actua act WHERE atr.cod_act = act.cod_act AND NOT EXISTS(SELECT p.cod_peli FROM Pelicula p WHERE p.director <> 'John Steel' AND act.cod_peli = p.cod_peli))
#+end_src

*** 36. Obtener el código y el título de las películas de menos de 100 minutos en las que todos los actores que han actuado son de un mismo país.

#+begin_src sql
SELECT p.cod_peli, p.titulo
FROM pelicula p 
WHERE duracion < 100 
        AND
     EXISTS (SELECT *
            FROM actua act
            WHERE act.cod_peli = p.cod_peli)
       AND
     NOT EXISTS (SELECT * 
                 FROM actua a, actua a2
                 WHERE p.cod_peli = a.cod_peli AND p.cod_peli = a2.cod_peli
                    AND
                 NOT EXISTS (SELECT *
                             FROM actor ac
                             WHERE a.cod_act = ac.cod_act
                                    AND 
                                   NOT EXISTS (
                                       SELECT *
                                       FROM actor ac2
                                       WHERE ac2.cod_act <> ac.cod_act
                                            and
                                             ac2.cod_pais <> ac.cod_pais 
                                            and 
                                             a2.cod_act = ac2.cod_act
                                             
                                   )
                            )
                 )
#+end_src

*** 37. Obtener el código, el título y el año de las películas en las que haya actuado algún actor si se cumple que todos los actores que han actuado en ella han nacido antes del año 1943 (hasta el 31/12/1942).

#+begin_src sql
SELECT p.cod_peli, p.titulo, p.anyo
FROM Pelicula p
WHERE EXISTS (SELECT * FROM Actua ac WHERE p.cod_peli = ac.cod_peli) AND NOT EXISTS 
            (SELECT act.cod_peli FROM Actua act WHERE act.cod_peli = p.cod_peli AND EXISTS 
            (SELECT atr.cod_act FROM Actor atr WHERE atr.fecha_nac >= '31/12/1942' AND atr.cod_act = act.cod_act))
#+end_src

*** 38. Obtener el código y el nombre de cada país si se cumple que todos sus actores han actuado en al menos una película de más de 120 minutos. (Ordenados por nombre).

#+begin_src sql
SELECT p.cod_pais, p.nombre
FROM pais p
WHERE EXISTS(
        SELECT *
        FROM actor a1
        WHERE a1.cod_pais = p.cod_pais
    )
AND
NOT EXISTS (
              SELECT *
              FROM actor a
              WHERE a.cod_pais = p.cod_pais
                AND  
              NOT EXISTS (
                  SELECT *
                  FROM actua ac, pelicula pel
                  WHERE ac.cod_peli = pel.cod_peli
                          AND
                        a.cod_act = ac.cod_act
                          AND 
                        pel.duracion > 120 
              )
        )
ORDER BY p.nombre
#+end_src

*** 39. Obtener el código y el título del libro o libros en que se ha basado más de una película, indicando cuántas películas se han hecho sobre él.

#+begin_src sql
SELECT l.cod_lib, l.titulo, COUNT(*)
FROM Libro_peli l, Pelicula p1
WHERE 1 < (SELECT COUNT(*)
           FROM pelicula p
           WHERE p.cod_lib = l.cod_lib)
      AND L.cod_lib = p1.cod_lib
GROUP BY l.cod_lib, l.titulo
#+end_src

*** 40. Obtener para cada género en el que se han clasificado más de 5 películas, el código y el nombre del género indicando la cantidad de películas del mismo y duración media de sus películas. (Ordenados por nombre).

#+begin_src sql
SELECT g.cod_gen, g.nombre, COUNT(distinct c.cod_peli), ROUND(AVG(p.duracion))
FROM Genero g, Clasificacion c, Pelicula p
WHERE c.cod_gen = g.cod_gen AND p.cod_peli = c.cod_peli
GROUP BY g.cod_gen, g.nombre
HAVING count(c.cod_peli) > 5
ORDER BY g.nombre
#+end_src

*** 41. Obtener el código y el título de las películas de año posterior al 2000 junto con el número de géneros en que están clasificadas, si es que están en alguno. (Ordenadas por título).

#+begin_src sql
SELECT p.cod_peli, p.titulo, COUNT(DISTINCT c.cod_gen)
FROM Pelicula p, Clasificacion c
WHERE p.anyo > 2000 AND p.cod_peli = c.cod_peli
GROUP BY p.cod_peli, p.titulo
ORDER BY p.titulo
#+end_src

*** 42. Obtener los directores que tienen la cadena ‘George’ en su nombre y que han dirigido exactamente dos películas.

#+begin_src sql
SELECT p.director
FROM Pelicula p
WHERE p.director LIKE '%George%'
GROUP BY p.director
HAVING COUNT(*) = 2
#+end_src

*** 43. Obtener para cada película clasificada exactamente en un género y en la que haya actuado algún actor, el código, el título y la cantidad de actores que actúan en ella.

#+begin_src sql
SELECT p.cod_peli, p.titulo, COUNT(a.cod_act)
FROM Pelicula p, Actua a
WHERE 1 = (SELECT COUNT(c.cod_gen) FROM Clasificacion c WHERE c.cod_peli = p.cod_peli) AND a.cod_peli = p.cod_peli AND a.cod_act IS NOT NULL
GROUP BY p.cod_peli, p.titulo
ORDER BY p.titulo
#+end_src

*** 44. Obtener el código y el nombre de todos los países con actores indicando cuántos actores de cada país han actuado en al menos una película de la década de los 60.

#+begin_src sql
SELECT p.cod_pais, p.nombre, COUNT(DISTINCT a.cod_act)
FROM Pais p, Actor a, Actua ac, Pelicula pe
WHERE pe.anyo BETWEEN 1960 AND 1969 AND p.cod_pais = a.cod_pais AND a.cod_act = ac.cod_act AND ac.cod_peli = pe.cod_peli
GROUP BY p.cod_pais, p.nombre
HAVING COUNT(a.cod_act) > 0
ORDER BY p.nombre
#+end_src

*** 45. Obtener el código, el nombre del género en el que hay clasificadas más películas (puede haber más de uno).

#+begin_src sql
SELECT g.cod_gen, g.nombre
FROM Genero g, Clasificacion c
WHERE c.cod_gen = g.cod_gen
GROUP BY g.cod_gen, g.nombre
HAVING count(c.cod_peli) = (SELECT MAX(COUNT(distinct c2.cod_peli))
                           FROM Genero g2, Clasificacion c2
                           WHERE c2.cod_gen = g2.cod_gen
                           GROUP BY g2.cod_gen, g2.nombre)
ORDER BY g.nombre
#+end_src

*** 46. Obtener el código, el título y el autor del libro en el que se han basado más películas (puede haber más de uno).

#+begin_src sql
SELECT l.cod_lib, l.titulo, l.autor
FROM Libro_peli l, Pelicula p 
WHERE l.cod_lib = p.cod_lib
GROUP BY l.cod_lib, l.titulo, l.autor
HAVING COUNT(p.cod_peli) = (SELECT MAX(COUNT(p2.cod_peli))
                            FROM Libro_peli l2, Pelicula p2 
                            WHERE l2.cod_lib = p2.cod_lib
                            GROUP BY l2.cod_lib)

#+end_src

*** 47. Obtener el código y el nombre del país que más actores tiene que hayan participado exactamente en 2 películas

#+begin_src sql

SELECT p.cod_pais, p.nombre
FROM Pais p, Actor a
WHERE p.cod_pais = a.cod_pais AND a.cod_act IN (SELECT (ac1.cod_act) 
                                                FROM Actua ac1 
                                                GROUP BY ac1.cod_act 
                                                HAVING COUNT(ac1.cod_peli) = 2)
GROUP BY p.cod_pais, p.nombre
HAVING COUNT(*) = (SELECT MAX(COUNT(*))
                   FROM Pais p1, Actor a1
                   WHERE p1.cod_pais = a1.cod_pais AND a1.cod_act IN (SELECT (ac1.cod_act) 
                                                                      FROM Actua ac1 
                                                                      GROUP BY ac1.cod_act 
                                                                      HAVING COUNT(ac1.cod_peli) = 2) 
                   GROUP BY p1.cod_pais);

#+end_src

*** 48. Obtener el año o años en el que nacieron más de 3 actores indicando cuántos nacieron exactamente.

#+begin_src sql
SELECT EXTRACT(YEAR FROM fecha_nac), COUNT(fecha_nac)
FROM Actor
GROUP BY EXTRACT(YEAR FROM fecha_nac)
HAVING COUNT(fecha_nac) > 3

#+end_src

*** 49. Obtener el código y el título de las películas de menos de 100 minutos en las que todos los actores que han actuado son de un mismo país.

#+begin_src sql

SELECT p.cod_peli, p.titulo
FROM pelicula p, actor a, actua ac
WHERE p.cod_peli = ac.cod_peli AND a.cod_act = ac.cod_act AND p.duracion < 100
GROUP BY p.cod_peli, p.titulo
HAVING count(distinct a.cod_pais) = 1

#+end_src

** 3.6 Consultas con concatenación

*** 50. Obtener para todos los países que hay en la base de datos, el código, el nombre y la cantidad de actores que hay de ese país.

#+begin_src sql
SELECT p.cod_pais, p.nombre, count(a.cod_act)
FROM Pais p LEFT JOIN Actor a ON p.cod_pais = a.cod_pais
GROUP BY p.cod_pais, p.nombre
ORDER BY p.nombre
#+end_src

*** 51. Obtener el código y el título de todos los libros de la base de datos de año posterior a 1980 junto con la cantidad de películas a que han dado lugar.

#+begin_src sql
SELECT l.cod_lib, l.titulo, count(p.cod_peli)
FROM libro_peli l LEFT JOIN pelicula p ON l.cod_lib = p.cod_lib
WHERE l.anyo > 1980
GROUP BY l.cod_lib, l.titulo
#+end_src

*** 52. Obtener para todos los países que hay en la base de datos, el código, el nombre y la cantidad de actores que hay de ese país.

#+begin_src sql

SELECT p.cod_pais, p.nombre, count(DISTINCT a.cod_act)
FROM Pais p LEFT JOIN (Actor a JOIN Actua ac ON a.cod_act = ac.cod_act AND ac.papel = 'Secundario') ON p.cod_pais = a.cod_pais
GROUP BY p.cod_pais, p.nombre
ORDER BY p.nombre
#+end_src

*** 53. Obtener para cada película que hay en la base de datos que dure más de 140 minutos, el código, el título, la cantidad de géneros en los que está clasificado y la cantidad de actores que han actuado en ella

#+begin_src sql
SELECT p.cod_peli, p.titulo, COUNT(DISTINCT c.cod_gen), COUNT(DISTINCT a.cod_act)
FROM (Pelicula p LEFT JOIN Actua a ON p.cod_peli = a.cod_peli) LEFT JOIN Clasificacion c ON p.cod_peli = c.cod_peli
WHERE p.duracion > 140
GROUP BY p.cod_peli, p.titulo
ORDER BY p.titulo
#+end_src

** Consultas conjuntistas
*** 54. Obtener los años, ordenados ascendentemente, que aparecen en la base de datos como año en el que se editó un libro o se filmó una película. Sólo interesan años en los que no aparezca el dígito 9. 
-- Ejercicio 54
SELECT l.anyo
FROM libro_peli l
WHERE l.anyo NOT LIKE '%9%'
UNION 
(SELECT p.anyo
FROM pelicula p
WHERE p.anyo NOT LIKE '%9%');

*** 55. Obtener el nombre del género (o de los géneros) a los que pertenece la película de duración máxima.
SELECT g.cod_gen, g.nombre
FROM genero g
WHERE g.cod_gen IN (SELECT c.cod_gen
                    FROM clasificacion c
                    WHERE c.cod_peli = (SELECT p.cod_peli
                                        FROM pelicula p 
                                        WHERE p.duracion = (SELECT MAX (p2.duracion)
                                                          FROM pelicula p2)));
                                                          

*** 56. Obtener, para cada actor nacido antes de 1948 y que haya actuado en al menos 2 películas en cualquier papel, el código, el nombre y la fecha de nacimiento indicando en cuántas películas ha actuado con el papel de ‘Principal’
SELECT a.cod_act, a.nombre, a.fecha_nac, COUNT(act.cod_peli)
FROM actor a LEFT JOIN actua act ON a.cod_act = act.cod_act AND act.papel = 'Principal'
WHERE a.cod_act IN (SELECT a2.cod_act
                    FROM actor a2
                    WHERE 2 < (SELECT count(*)
                               FROM actua act2
                               WHERE act2.cod_act = a2.cod_act)) 
     AND extract (year from a.fecha_nac ) < 1948 
GROUP BY a.cod_act, a.nombre, a.fecha_nac
ORDER BY a.nombre;

*** 57. Obtener el código y el nombre de los actores que sólo han actuado en películas posteriores a 1994.

SELECT a.cod_act, a.nombre
FROM actor a
WHERE NOT EXISTS (SELECT *
                  FROM actua ac
                  WHERE ac.cod_act = a.cod_act 
                    AND EXISTS (SELECT *
                                    FROM pelicula p 
                                    WHERE p.cod_peli = ac.cod_peli
                                      AND p.anyo <= 1994))
  AND EXISTS (SELECT *
              FROM actua ac
              WHERE ac.cod_act = a.cod_act)
ORDER BY a.nombre              



* Base de Datos MÚSICA

#+NAME: Base de datos CINE
[[./MUSICA.png]]

**  Consultas sobre una sola relación
*** 1. ¿Cuántos discos hay?

#+begin_src sql
SELECT count(cod)
FROM Disco
#+end_src

*** 2. Selecciona el nombre de los grupos que no sean de España.

#+begin_src sql
SELECT nombre
FROM Grupo
WHERE pais <> 'España'
#+end_src

*** 3. Obtener el título de las canciones con más de 5 minutos de duración.

#+begin_src sql
SELECT titulo
FROM Cancion
WHERE duracion > 5
#+end_src

*** 4. Obtener la lista de las distintas funciones que se pueden realizar en un grupo.

#+begin_src sql
SELECT DISTINCT funcion
FROM Pertenece
#+end_src

*** 5. Obtener la lista de clubs de fans junto con su tamaño (número de personas). La lista debe estar ordenada de menor a mayor según el tamaño del club.

#+begin_src sql
SELECT nombre, num
FROM club
ORDER BY num
#+end_src

*** 6. Selecciona el nombre y la sede de los clubes de fans con más de 500 socios. 

#+begin_src sql
SELECT nombre, sede
FROM Club
WHERE num > 500
#+end_src

** Consultas sobre varias relaciones
*** 7. Obtener el nombre y la sede de cada club de fans de grupos de España así como el nombre del grupo al que admiran.

#+begin_src sql
SELECT c.nombre, c.sede, g.nombre
FROM Club c, Grupo g
WHERE c.cod_gru = g.cod AND g.pais = 'España'
#+end_src

*** 8. Obtener el nombre de los artistas que pertenezcan a un grupo de España.

#+begin_src sql
SELECT nombre
FROM artista a, pertenece p, grupo g
WHERE a.dni = p.dni AND p.cod = g.cod AND g.pais = 'España'
#+end_src

*** 9. Obtener el nombre de los discos que contienen alguna canción que dure más de 5 minutos.

#+begin_src sql
SELECT DISTINCT d.nombre
FROM Disco d, Esta e, Cancion c
WHERE c.duracion > 5 AND c.cod = e.can AND e.cod = d.cod
#+end_src

*** 10. Obtener los nombres de las canciones que dan nombre al disco en el que aparecen.

#+begin_src sql
SELECT c.titulo  
FROM  cancion c, esta e, disco d
WHERE c.cod = e.can AND e.cod = d.cod AND c.titulo = d.nombre
#+end_src

*** 11. Obtener los nombres de compañías y direcciones postales de aquellas compañías que han grabado algún disco que empiece por ‘A’.

#+begin_src sql
SELECT c.nombre, c.dir
FROM Companyia c, Disco d
WHERE c.cod = d.cod_comp AND d.nombre LIKE 'A%'
#+end_src

*** 12. DNI de los artistas que pertenecen a más de un grupo.

#+begin_src sql
SELECT DISTINCT a.dni
FROM Artista a, Pertenece p1, Pertenece p2
WHERE a.dni = p1.dni AND p1.dni = p2.dni AND p1.cod <> p2.cod
#+end_src

** Consultas con subconsultas
*** 13. Obtener el nombre de los discos del grupo más viejo.

#+begin_src sql
SELECT d.nombre
FROM Disco d
WHERE d.cod_gru IN (SELECT g.cod FROM Grupo g WHERE g.fecha IN (SELECT MIN(fecha) FROM Grupo))
#+end_src

*** 14. Obtener el nombre de los discos grabados por grupos con club de fans con más de 5000 personas

#+begin_src sql
SELECT d.nombre
FROM Disco d
WHERE d.cod_gru IN (SELECT c.cod_gru FROM Club c WHERE c.num > 5000)
#+end_src

*** 15. Obtener el nombre de los clubes con mayor número de fans indicando ese número.

#+begin_src sql
SELECT nombre, num
FROM club  
WHERE num = (SELECT MAX(num) FROM club)
#+end_src

*** 16. Obtener el título de las canciones de mayor duración indicando la duración.

#+begin_src sql
SELECT c1.titulo, c1.duracion
FROM Cancion c1
WHERE c1.duracion = (SELECT MAX(c2.duracion) FROM Cancion c2)
#+end_src

** Consultas con cuantificación universal
*** 17. Obtener el nombre de las compañías discográficas que no han trabajado con grupos españoles.

#+begin_src sql
SELECT c.nombre
FROM Companyia c
WHERE NOT EXISTS (SELECT * FROM Disco d WHERE d.cod_comp = c.cod AND EXISTS (SELECT * FROM Grupo g WHERE g.pais = 'España' AND d.cod_gru = g.cod))
#+end_src

*** 18. Obtener el nombre de las compañías discográficas que sólo han trabajado con grupos españoles.

#+begin_src sql
SELECT c.nombre
FROM Companyia c
WHERE EXISTS (SELECT * FROM Disco d WHERE d.cod_comp = c.cod AND NOT EXISTS (SELECT * FROM Grupo g WHERE g.pais <> 'España' AND d.cod_gru = g.cod))
#+end_src

*** 19.Obtener el nombre y la dirección de aquellas compañías discográficas que han grabado todos los discos de algún grupo.

#+begin_src sql
SELECT c.nombre, c.dir
FROM Companyia c
WHERE EXISTS (SELECT * FROM Disco d WHERE c.cod = d.cod_comp
AND NOT EXISTS (SELECT * FROM Disco d1 WHERE c.cod <> d1.cod_comp AND d1.cod_gru = d.cod_gru))
#+end_src

* Base de Datos BIBLIOTECA 

#+NAME: Base de datos BIBLIOTECA
[[./BIBLIOTECA.PNG]]

** Consultas sobre una sola relación
*** 1. Obtener el nombre de los autores de nacionalidad ‘Argentina’.

#+begin_src sql
SELECT nombre
FROM Autor
WHERE nacionalidad = 'Argentina';
#+end_src

*** 2. Obtener los títulos de las obras que contengan la palabra ‘mundo’

#+begin_src sql
SELECT titulo
FROM Obra
WHERE titulo LIKE '%mundo%';
#+end_src

*** 3. Obtener el identificador de los libros anteriores a 1990 y que contengan más de una obra indicando el número de obras que contiene.

#+begin_src sql
SELECT id_lib, num_obras
FROM Libro
WHERE año < 1990 AND num_obras > 1;
#+end_src

*** 4. ¿Cuántos libros hay de los que se conozca el año de publicación?

#+begin_src sql
SELECT COUNT(*)
FROM Libro
WHERE año IS NOT NULL;
#+end_src

*** 5. ¿Cuántos libros tienen más de una obra? Resolver este ejercicio utilizando el atributo num_obras.

#+begin_src sql
SELECT COUNT(*)
FROM Libro
WHERE num_obras > 1;
#+end_src

*** 6. Obtener el identificador de los libros del año 1997 que no tienen título.

#+begin_src sql
SELECT id_lib
FROM Libro
WHERE año = 1997 AND titulo IS NULL;
#+end_src

*** 7. Mostrar todos los títulos de los libros que tienen título en orden alfabético descendente.

#+begin_src sql
SELECT titulo
FROM Libro
WHERE titulo IS NOT NULL
ORDER BY titulo DESC;
#+end_src

*** 8. Obtener cuántas obras hay en los libros publicados entre 1990 y 1999.

#+begin_src sql
SELECT SUM(num_obras)
FROM Libro
WHERE año BETWEEN 1990 AND 1999;
#+end_src

** Consultas sobre varias relaciones
*** 9. Obtener cuántos autores han escrito alguna obra con la palabra “ciudad” en su título.

#+begin_src sql
SELECT COUNT(e.autor_id)
FROM Escribir e, Obra o
WHERE o.cod_ob = e.cod_ob AND o.titulo LIKE '% ciudad %';
#+end_src

*** 10. Obtener el título de todas las obras escritas por el autor de nombre ‘Camús, Albert’.

#+begin_src sql
SELECT o.titulo
FROM Obra o, Escribir e, Autor a
WHERE a.nombre = 'Camús, Albert' AND a.autor_id = e.autor_id AND e.cod_ob = o.cod_ob;
#+end_src

*** 11. ¿Quién es el autor de la obra de título ‘La tata’?

#+begin_src sql
SELECT a.nombre
FROM Obra o, Escribir e, Autor a
WHERE o.titulo = 'La tata' AND o.cod_ob = e.cod_ob AND e.autor_id = a.autor_id;
#+end_src

*** 12. Obtener el nombre de los amigos que han leído alguna obra del autor de identificador ‘RUKI’.

#+begin_src sql
SELECT DISTINCT am.nombre
FROM Amigo am, Leer l, Escribir e
WHERE e.autor_id = 'RUKI' AND e.cod_ob = l.cod_ob AND l.num = am.num;
#+end_src

*** 13. Obtener el título y el identificador de los libros que tengan título y más de una obra. Resolver este ejercicio sin utilizar el atributo num_obras.

#+begin_src sql
SELECT DISTINCT l.id_lib, l.titulo
FROM Libro l, Esta_en e1, Esta_en e2
WHERE l.titulo IS NOT NULL AND l.id_lib = e1.id_lib AND l.id_lib = e2.id_lib AND e1.cod_ob <> e2. cod_ob;
#+end_src

** Consultas con subconsultas
*** 14. Obtener el título de las obras escritas sólo por un autor si éste es de nacionalidad “Francesa” indicando también el nombre del autor.
//REVISAR
#+begin_src sql
SELECT o.titulo, a.nombre
FROM Obra o, Autor a
WHERE a.nacionalidad = 'Francesa' AND 1 = (SELECT COUNT(*) FROM Escribir e WHERE o.cod_ob = e.cod_ob AND a.autor_id = e.autor_id);
#+end_src

*** 15. ¿Cuántos autores hay en la base de datos de los que no se tiene ninguna obra?

#+begin_src sql
SELECT COUNT(*)
FROM Autor a
WHERE a.autor_id NOT IN (SELECT e.autor_id FROM Escribir e WHERE e.cod_ob IS NOT NULL);
#+end_src

*** 16. Obtener el nombre de esos autores.

#+begin_src sql
SELECT a.nombre
FROM Autor a
WHERE a.autor_id NOT IN (SELECT e.autor_id FROM Escribir e WHERE e.cod_ob IS NOT NULL);
#+end_src

*** 17. Obtener el nombre de los autores de nacionalidad “Española” que han escrito dos o más obras.

#+begin_src sql
SELECT a.nombre
FROM Autor a
WHERE a.nacionalidad = 'Española' AND 1 < (SELECT COUNT(*) FROM Escribir e WHERE e.autor_id = a.autor_id);
#+end_src

*** 18. Obtener el nombre de los autores de nacionalidad “Española” que han escrito alguna obra que está en dos o más libros.

#+begin_src sql
SELECT a.nombre
FROM Autor a
WHERE a.nacionalidad = 'Española' AND EXISTS (SELECT * FROM Escribir e WHERE e.autor_id = a.autor_id AND 1 < (SELECT COUNT(*) FROM Esta_en ee WHERE e.cod_ob = ee.cod_ob));
#+end_src

*** 19. Obtener el título y el código de las obras que tengan más de un autor.

#+begin_src sql
SELECT o.titulo, o.cod_ob
FROM Obra o
WHERE 1 < (SELECT COUNT(e.autor_id) FROM Escribir e WHERE o.cod_ob = e.cod_ob);
#+end_src
